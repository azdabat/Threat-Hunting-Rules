let SuspiciousPortsData = externaldata(dest_port:int, metadata_comment:string, metadata_confidence:string, metadata_detection_type:string, metadata_link:string, metadata_reference:string)[@"https://raw.githubusercontent.com/mthcht/awesome-lists/main/Lists/suspicious_ports_list.csv"] with (format='csv', ignoreFirstRecord=true) | where metadata_confidence != "low"; 
let SuspiciousPortList = toscalar(SuspiciousPortsData | summarize make_set(dest_port)); 
let PortDetails = SuspiciousPortsData | project dest_port, metadata_comment, metadata_confidence; 
DeviceNetworkEvents 
| where RemotePort in (SuspiciousPortList) and RemotePort != 8080 
| where RemoteIP !in~ ("::1", "::ffff:127.0.0.1") 
| where not(RemoteIP startswith "10." or RemoteIP startswith "192.168." or RemoteIP startswith "172." or RemoteIP startswith "8." or RemoteIP startswith "127.") 
| join kind=inner (PortDetails) on $left.RemotePort == $right.dest_port 
| summarize FirstSeen=min(Timestamp), LastSeen=max(Timestamp), Count=count(), SampleProcess=arg_max(Timestamp, InitiatingProcessFileName), SampleCommand=arg_max(Timestamp, InitiatingProcessCommandLine) by DeviceName, RemoteIP, RemotePort, metadata_comment, metadata_confidence 
| extend RiskLevel=case(metadata_confidence=="high","CRITICAL", metadata_confidence=="medium","HIGH","MEDIUM") 
| where RiskLevel in ("HIGH","CRITICAL") 
| extend MITRE_Tactics="TA0011: Command and Control", MITRE_Techniques=case(RemotePort==1080,"T1090: Proxy", RemotePort==1194,"T1573: Encrypted Channel","T1071: Application Layer Protocol"), VT_Link=strcat("https://www.virustotal.com/gui/ip-address/", RemoteIP) 
| extend HuntingDirectives=pack_array(strcat("1. Verify legitimacy of process: ",SampleProcess), strcat("2. Inspect command line for anomalies: ",SampleCommand), strcat("3. Review ", Count, " suspicious connections to ", RemoteIP), strcat("4. Check VirusTotal reputation: ", VT_Link), strcat("5. Port usage context: ", metadata_comment), "6. Correlate with DeviceProcessEvents for parent-child process tree", "7. Check DeviceLogonEvents to identify the user session", "8. Isolate endpoint if risk is confirmed and collect memory dump") 
| project FirstSeen, LastSeen, DeviceName, RemoteIP, RemotePort, Count, RiskLevel, PortContext=metadata_comment, Confidence=metadata_confidence, SampleProcess, SampleCommand, MITRE_Tactics, MITRE_Techniques, VT_Link, HuntingDirectives 
| order by RiskLevel desc, Count desc, FirstSeen desc

------------------------


let SuspiciousPortsData = externaldata(dest_port:int, metadata_comment:string, metadata_confidence:string, metadata_detection_type:string, metadata_link:string, metadata_reference:string)
[@"https://raw.githubusercontent.com/mthcht/awesome-lists/main/Lists/suspicious_ports_list.csv"]
with (format='csv', ignoreFirstRecord=true)
| where metadata_confidence != "low";
let SuspiciousPortList = toscalar(SuspiciousPortsData | summarize make_set(dest_port)); 
let PortDetails = SuspiciousPortsData | project dest_port, metadata_comment, metadata_confidence; 
DeviceNetworkEvents
| where RemotePort in (SuspiciousPortList) and RemotePort != 8080 
| where ActionType == "InboundConnectionAccepted"
| where RemoteIP !in~ ("::1", "::ffff:127.0.0.1") 
| where not(RemoteIP startswith "10." or RemoteIP startswith "192.168." or RemoteIP startswith "172." or RemoteIP startswith "8." or RemoteIP startswith "127.") 
| join kind=inner (PortDetails) on $left.RemotePort == $right.dest_port 
| summarize 
    FirstSeen=min(Timestamp), 
    LastSeen=max(Timestamp), 
    Count=count(), 
    SampleProcess=arg_max(Timestamp, InitiatingProcessFileName), 
    SampleCommand=arg_max(Timestamp, InitiatingProcessCommandLine) 
    by DeviceName, RemoteIP, RemotePort, ActionType, metadata_comment, metadata_confidence 
| extend RiskLevel=case(metadata_confidence=="high","CRITICAL", metadata_confidence=="medium","HIGH","MEDIUM") 
| where RiskLevel in ("HIGH","CRITICAL") 
| extend 
    MITRE_Tactics="TA0011: Command and Control", 
    MITRE_Techniques=case(RemotePort==1080,"T1090: Proxy", RemotePort==1194,"T1573: Encrypted Channel","T1071: Application Layer Protocol"), 
    VT_Link=strcat("https://www.virustotal.com/gui/ip-address/", RemoteIP) 
| extend HuntingDirectives=pack_array(
    strcat("1. Verify legitimacy of process: ",SampleProcess), 
    strcat("2. Inspect command line for anomalies: ",SampleCommand), 
    strcat("3. Review ", Count, " suspicious connections to ", RemoteIP), 
    strcat("4. Check VirusTotal reputation: ", VT_Link), 
    strcat("5. Port usage context: ", metadata_comment), 
    "6. Correlate with DeviceProcessEvents for parent-child process tree", 
    "7. Check DeviceLogonEvents to identify the user session", 
    "8. Isolate endpoint if risk is confirmed and collect memory dump"
) 
| project 
    FirstSeen, 
    LastSeen, 
    DeviceName, 
    RemoteIP, 
    RemotePort, 
    ActionType,      // <-- This will show InboundConnectionAccepted
    Count, 
    RiskLevel, 
    PortContext=metadata_comment, 
    Confidence=metadata_confidence, 
    SampleProcess, 
    SampleCommand, 
    MITRE_Tactics, 
    MITRE_Techniques, 
    VT_Link, 
    HuntingDirectives 
| order by RiskLevel desc, Count desc, FirstSeen desc

