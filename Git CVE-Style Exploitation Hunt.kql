// ============================================================================
// Rule Name: Suspicious Git Submodule / Hook Abuse Hunt (CVE-Style 2025)
// Author: Ala Dabat
// Purpose:
//   Hunt for suspicious git usage on endpoints which can indicate exploitation
//   of modern Git vulnerabilities (e.g. CVE-2025-48384) by abusing submodules
//   and hooks for code execution.
// Data Sources: DeviceProcessEvents, DeviceFileEvents, DeviceInfo
// MITRE: TA0002 Execution, TA0003 Persistence, TA0005 Defense Evasion
// ============================================================================

let lookback = 7d;

// Stage 1: Suspicious git command lines with submodules / hooks
let SuspiciousGitExec =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where FileName =~ "git.exe"
| extend LowerCmd = tolower(ProcessCommandLine)
| where LowerCmd has_any ("submodule", "--recurse-submodules", "--recurse", "clone")
       or LowerCmd has_any (".git/hooks", "hooksPath")
| extend
    GitWorkingDir = tostring(FolderPath),
    GitUserAccount = coalesce(AccountUpn, strcat(AccountDomain, "\\", AccountName))
| project Timestamp, DeviceId, DeviceName, GitWorkingDir, GitUserAccount,
          GitProcessCommand = ProcessCommandLine,
          GitParentProcess  = InitiatingProcessFileName,
          GitParentCommand  = InitiatingProcessCommandLine;

// Stage 2: Hooks / suspicious files written under .git/hooks
let GitHookWrites =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where FolderPath has ".git\\hooks"
| where ActionType in ("FileCreated","FileModified")
| extend LowerName = tolower(FileName)
| where LowerName !in ("readme","sample")
| project Timestamp, DeviceId, DeviceName,
          HookFileName   = FileName,
          HookFolderPath = FolderPath,
          HookSHA256     = SHA256;

// Stage 3: Join git executions to hook writes per device within a short time window
SuspiciousGitExec
| join kind=inner (
    GitHookWrites
    | project HookTimestamp = Timestamp, DeviceId, HookFileName, HookFolderPath, HookSHA256
) on DeviceId
| where HookTimestamp between (Timestamp - 30m .. Timestamp + 30m)
| summarize
    FirstSeen = min(Timestamp),
    LastSeen  = max(Timestamp),
    GitExecutionCount = dcount(GitProcessCommand),
    GitWorkingDirs    = make_set(GitWorkingDir, 5),
    HookFiles         = make_set(HookFileName, 5),
    HookPaths         = make_set(HookFolderPath, 5),
    SampleGitCmd      = any(GitProcessCommand),
    SampleParent      = any(GitParentProcess),
    SampleParentCmd   = any(GitParentCommand),
    SampleHookSHA256  = any(HookSHA256),
    SampleUser        = any(GitUserAccount)
  by DeviceId, DeviceName
// Join device context
| join kind=leftouter (
    DeviceInfo
    | project DeviceId, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags
) on DeviceId
// Confidence scoring
| extend
    ConfidenceScore = 50
        + iif(DeviceCategory =~ "Server", 10, 0)
        + iif(ExposureLevel =~ "High", 10, 0)
| extend
    Severity = case(
        ConfidenceScore >= 80, "HIGH",
        ConfidenceScore >= 60, "MEDIUM",
        "LOW"
    ),
    MITRE_Tactics    = "TA0002 Execution, TA0003 Persistence, TA0005 Defense Evasion",
    MITRE_Techniques = "T1059 Command Shell, T1547.004 Boot or Logon Autostart Execution: Winlogon Helper, Git Hook Abuse"
// Hunter directives
| extend HuntingDirectives = pack_array(
    strcat("1) Review suspicious git + hooks activity on device '", DeviceName, "'."),
    strcat("2) Check user: ", SampleUser, " and validate if they legitimately manage Git repos."),
    strcat("3) Inspect Git command: ", SampleGitCmd),
    strcat("4) Review hook files: ", tostring(HookFiles), " under ", tostring(HookPaths)),
    strcat("5) If HookSHA256 suspicious: upload to malware sandbox and check MISP/OpenCTI."),
    "6) If malicious, remove or replace hooks, rotate credentials, and audit the impacted repos."
)
| project FirstSeen,LastSeen,GitExecutionCount,Severity,ConfidenceScore,
          DeviceName,OSPlatform,DeviceCategory,ExposureLevel,DeviceTags,
          GitWorkingDirs,HookFiles,HookPaths,
          SampleGitCmd,SampleParent,SampleParentCmd,
          SampleUser,SampleHookSHA256,
          MITRE_Tactics,MITRE_Techniques,HuntingDirectives
| order by Severity desc, LastSeen desc
