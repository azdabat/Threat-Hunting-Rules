/* ============================================================================
   Rule Name: Suspicious Git Submodule / Hook Abuse Hunt
   Author: Ala Dabat
   Purpose:
     Identify suspicious Git activity involving submodules or hook files,
     which can be used for execution or persistence (e.g., modern Git vulns).
   Data: DeviceProcessEvents, DeviceFileEvents, DeviceInfo
   MITRE: TA0002 Execution, TA0003 Persistence, TA0005 Defense Evasion
   ============================================================================ */

let lookback = 7d;

// Suspicious Git executions involving submodules or hooks
let GitExec =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where FileName =~ "git.exe"
| extend Cmd = tolower(ProcessCommandLine)
| where Cmd has_any ("submodule","--recurse-submodules","--recurse","clone",".git/hooks","hookspath")
| extend
    WorkingDir = tostring(FolderPath),
    User = coalesce(AccountUpn, strcat(AccountDomain, "\\", AccountName))
| project Timestamp, DeviceId, DeviceName,
          WorkingDir, User,
          GitCmd = ProcessCommandLine,
          ParentProc = InitiatingProcessFileName,
          ParentCmd = InitiatingProcessCommandLine;

// Hook creation/modification
let HookWrites =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where FolderPath has ".git\\hooks"
| where ActionType in ("FileCreated","FileModified")
| extend NameLower = tolower(FileName)
| where NameLower !in ("readme","sample")
| project HookTime = Timestamp, DeviceId, HookFile = FileName,
          HookPath = FolderPath, HookSHA256 = SHA256;

// Correlate Git exec with hook writes on same device within Â±30 minutes
GitExec
| join kind=inner (
    HookWrites
) on DeviceId
| where HookTime between (Timestamp - 30m .. Timestamp + 30m)
| summarize
    FirstSeen = min(Timestamp),
    LastSeen  = max(Timestamp),
    GitExecCount = dcount(GitCmd),
    WorkingDirs  = make_set(WorkingDir, 5),
    HookFiles    = make_set(HookFile, 5),
    HookPaths    = make_set(HookPath, 5),
    SampleCmd    = any(GitCmd),
    SampleParent = any(ParentProc),
    SampleParentCmd = any(ParentCmd),
    SampleHookSHA256 = any(HookSHA256),
    SampleUser   = any(User)
  by DeviceId, DeviceName

// Device context
| join kind=leftouter (
    DeviceInfo
    | project DeviceId, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags
) on DeviceId

// Scoring
| extend ConfidenceScore =
      50
    + iif(DeviceCategory =~ "Server", 10, 0)
    + iif(ExposureLevel =~ "High", 10, 0)

| extend Severity = case(
        ConfidenceScore >= 80, "HIGH",
        ConfidenceScore >= 60, "MEDIUM",
        "LOW"
    )

| extend MITRE_Tactics = "TA0002 Execution; TA0003 Persistence; TA0005 Defense Evasion",
         MITRE_Techniques = "T1059 Shell Execution; T1547.004 Git Hook Abuse"

| extend HuntingDirectives = pack_array(
    strcat("Review Git + hook activity on device ", DeviceName, "."),
    strcat("User: ", SampleUser),
    strcat("Git Command: ", SampleCmd),
    strcat("Hook files: ", tostring(HookFiles), " under ", tostring(HookPaths)),
    "Check hook SHA256 in Defender, MISP, or sandbox.",
    "If malicious, remove hooks and audit repository integrity."
)

| project FirstSeen, LastSeen, GitExecCount, Severity, ConfidenceScore,
          DeviceName, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags,
          WorkingDirs, HookFiles, HookPaths,
          SampleCmd, SampleParent, SampleParentCmd,
          SampleUser, SampleHookSHA256,
          MITRE_Tactics, MITRE_Techniques, HuntingDirectives
| order by Severity desc, LastSeen desc
