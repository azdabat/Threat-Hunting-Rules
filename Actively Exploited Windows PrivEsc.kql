# L3 Threat Hunting SOP: Windows Kernel EoP & BYOVD Correlation
## Low/Medium → SYSTEM Jump • Vulnerable Driver Staging • Token Elevation

**Author:** Ala Dabat  
**Version:** 2025.12.Ultimate  
**Target Platform:** Microsoft Defender XDR / Sentinel (MDE Schema)

---

## 1. Executive Summary & Attack Path
This rule detects the "Kill Chain" of a kernel exploit. It looks for a suspicious driver load (BYOVD) followed immediately by a process integrity jump from Medium to System.



---

## 2. Advanced Correlation Query (KQL)

```kql
// ============================================================================
// Hunt Name: L3_Kernel_EoP_BYOVD_Correlation
// Purpose: Correlate Driver Loads with Medium->SYSTEM Process Jumps
// ============================================================================
let Lookback = 24h;
let CorrelationWindow = 10m;
let SuspiciousStarterProcesses = dynamic(["cmd.exe","powershell.exe","pwsh.exe","python.exe","poc.exe","exploit.exe","nc.exe","rundll32.exe"]);

// 1) Identify suspicious driver loads (BYOVD Staging)
let DriverLoads = DeviceImageLoadEvents
| where Timestamp >= ago(Lookback)
| where FileName endswith ".sys"
| where SignatureStatus in ("Unsigned", "Invalid", "Unknown") or isempty(Signer)
| project DriverLoadTime = Timestamp, DeviceId, DeviceName, DriverName = FileName, DriverFolderPath = FolderPath, DriverSigner = Signer;

// 2) Identify Medium -> SYSTEM integrity jumps
let IntegrityJumps = DeviceProcessEvents
| where Timestamp >= ago(Lookback)
| where InitiatingProcessIntegrityLevel in ("Low", "Medium")
| where TargetProcessIntegrityLevel == "System"
| where FileName !in~ ("lsass.exe", "winlogon.exe", "services.exe", "svchost.exe", "msiexec.exe")
| project JumpTime = Timestamp, DeviceId, 
          SourceProcess = InitiatingProcessFileName, SourceCmd = InitiatingProcessCommandLine,
          TargetProcess = FileName, TargetCmd = ProcessCommandLine;

// 3) Correlate Driver Load followed by Integrity Jump on the same device
DriverLoads
| join kind=inner (IntegrityJumps) on DeviceId
| where JumpTime between (DriverLoadTime .. DriverLoadTime + CorrelationWindow)
| extend LikelyExploit = iif(SourceProcess in~ (SuspiciousStarterProcesses) or SourceCmd has_any ("exploit","poc","kernel","bypass"), 1, 0)
| summarize 
    FirstSeen = min(DriverLoadTime),
    LastSeen = max(JumpTime),
    DriversLoaded = make_set(DriverName),
    ProcessesSpawned = make_set(TargetProcess),
    ExploitCmds = make_set(SourceCmd)
    by DeviceId, DeviceName, SourceProcess
| extend Severity = "Critical", 
         KillChainStage = "Privilege Escalation",
         MITRE = "T1068 (Exploitation for Privilege Escalation) / T1547.006 (Kernel Modules)"




// (IR Framework)

//Phase 1: Triage & Validation
//The "Jump" Logic:** Verify the `SourceProcess`. If `powershell.exe` spawned a `SYSTEM` process like `cmd.exe` or `whoami.exe` within 10 minutes of an unsigned driver loading, this is a **99% confirmed exploit**.
//Driver Reputation:** Check the `DriversLoaded` list. Search for these drivers on [LOLDrivers.io](https://loldrivers.io). If the driver is listed there, it is a confirmed BYOVD attack.



//Phase 2: Containment
//Isolate Host:** Kernel exploits often allow attackers to disable EDR sensors or hide processes. **Isolate the device immediately** via the Defender portal.
//Stop the Service:** If the driver created a new service, attempt to disable the service via remote CLI to prevent re-load on reboot.

//Phase 3: Investigation (Forensic Pivot)
//Timeline Analysis:** Look for network connections (`DeviceNetworkEvents`) initiated by the `TargetProcess`. Kernel exploits are often followed by immediate credential dumping (`lsass.exe` access).



//Phase 4: Eradication & Recovery
//1. **Remove Driver:** Delete the malicious `.sys` file from the disk.
//2. **Registry Cleanup:** Check `HKLM\SYSTEM\CurrentControlSet\Services` for any new entries related to the suspicious driver.
//3. **Reimage:** Because kernel memory may have been patched/tampered with (e.g., DKOM - Direct Kernel Object Manipulation), a **full reimage** of the OS is the only way to ensure 100% eradication.


// 4. Analyst Notes
//False Positives:** Legitimate low-level monitoring tools (e.g., CPU-Z, HWMonitor) use vulnerable drivers. Check if the `SourceProcess` is a known IT management tool.
//Signature Bypass:** Some modern exploits use **Expired Certificates** to sign drivers. Always check the `SignatureStatus` field in your triage.

---
**END OF SOP**
