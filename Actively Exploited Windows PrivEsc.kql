// ============================================================================
// Rule Name: Windows Privilege Escalation 2024–2025 Hunt (Kernel EoP Patterns)
// Author: Ala Dabat
// Purpose:
//   Hunt for privilege escalation patterns associated with modern kernel EoPs
//   (CLFS, Winsock, netfilter-related, and other 2024–2025 KEV Windows vulns).
//   Focuses on low-priv processes spawning or injecting into SYSTEM within
//   a short window, with suspicious tooling and LOLBins.
// Data Sources: DeviceProcessEvents, DeviceInfo
// MITRE: TA0004 Privilege Escalation, TA0005 Defense Evasion
// CPU Notes:
//   - Lookback: 24h
//   - Single summarize by DeviceId/TargetProcessName
//   - No cross-table joins beyond DeviceInfo
//   - Expected impact: low/medium
// ============================================================================

let lookback = 24h;

// Processes commonly seen around kernel EoP exploits (PoCs, tooling, lolbins)
let SuspiciousExploitLoaders = dynamic([
    "exploit.exe","poc.exe","whoami.exe","cmd.exe","powershell.exe","rundll32.exe",
    "python.exe","pwsh.exe","nc.exe","plink.exe"
]);

DeviceProcessEvents
| where Timestamp >= ago(lookback)
| extend
    InitiatingAccountSid   = tostring(InitiatingProcessAccountSid),
    InitiatingAccountName  = tostring(InitiatingProcessAccountName),
    TargetAccountName      = tostring(AccountName),
    TargetIntegrityLevel   = tostring(TargetProcessIntegrityLevel),
    InitiatingIntegrity    = tostring(InitiatingProcessIntegrityLevel)
// Focus on low → SYSTEM jumps
| where InitiatingIntegrity in ("Low","Medium") and TargetIntegrityLevel == "System"
| where FileName !in~ ("lsass.exe","winlogon.exe","services.exe") // ignore core OS daemons
| extend
    LikelyExploitChain =
        iif(InitiatingProcessFileName in (SuspiciousExploitLoaders) or
            InitiatingProcessCommandLine has_any ("exploit","poc","cve-2024","cve-2025"), true, false)
| where LikelyExploitChain == true
// Summarize per Device + Target process
| summarize
    FirstSeen = min(Timestamp),
    LastSeen  = max(Timestamp),
    EventCount = count(),
    ExampleTargetProcess = any(FileName),
    ExampleTargetCommand = any(ProcessCommandLine),
    ExampleInitiatingProcess = any(InitiatingProcessFileName),
    ExampleInitiatingCommand = any(InitiatingProcessCommandLine),
    ExampleInitiatingAccount = any(InitiatingAccountName),
    ExampleTargetAccount = any(TargetAccountName)
  by DeviceId, DeviceName
// Join device context
| join kind=leftouter (
    DeviceInfo
    | project DeviceId, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags
) on DeviceId
// Confidence
| extend
    ConfidenceScore = 60
        + iif(DeviceCategory =~ "Server", 10, 0)
        + iif(ExposureLevel =~ "High", 10, 0)
| extend
    Severity = case(
        ConfidenceScore >= 80, "HIGH",
        ConfidenceScore >= 60, "MEDIUM",
        "LOW"
    ),
    MITRE_Tactics    = "TA0004 Privilege Escalation, TA0005 Defense Evasion",
    MITRE_Techniques = "T1068 Exploitation for Privilege Escalation"
// Hunter directives
| extend HuntingDirectives = pack_array(
    strcat("1) Review low→SYSTEM jump on device '", DeviceName, "'."),
    strcat("2) Check initiating process: ", ExampleInitiatingProcess,
           " | CmdLine: ", ExampleInitiatingCommand),
    strcat("3) Check SYSTEM target process: ", ExampleTargetProcess,
           " | CmdLine: ", ExampleTargetCommand),
    strcat("4) Validate whether account ", ExampleInitiatingAccount, " is allowed to perform admin tasks."),
    "5) Pivot to other processes on same device around FirstSeen and LastSeen.",
    "6) Cross-check: any kernel exploit binaries, CLFS/Winsock/netfilter PoCs, or unusual drivers loaded?"
)
| project FirstSeen,LastSeen,EventCount,Severity,ConfidenceScore,
          DeviceName,OSPlatform,DeviceCategory,ExposureLevel,DeviceTags,
          ExampleInitiatingProcess,ExampleInitiatingCommand,
          ExampleTargetProcess,ExampleTargetCommand,
          ExampleInitiatingAccount,ExampleTargetAccount,
          MITRE_Tactics,MITRE_Techniques,HuntingDirectives
| order by Severity desc, LastSeen desc
