// Suspicious Ports â€” Outbound/Any-Connection variant
// Purpose: alert on any network connection using community-listed suspicious ports
// Author: Ala Dabat (annotated)

// 1) Pull in external CSV of suspicious ports. externaldata requires exact column order & types.
//    We're declaring column types: dest_port:int, metadata_comment:string, metadata_confidence:string, ...
let SuspiciousPortsData =
    externaldata(dest_port:int, metadata_comment:string, metadata_confidence:string,
                 metadata_detection_type:string, metadata_link:string, metadata_reference:string)
    [@"https://raw.githubusercontent.com/mthcht/awesome-lists/main/Lists/suspicious_ports_list.csv"]
    with (format='csv', ignoreFirstRecord=true)
| where metadata_confidence != "low";                // drop low-confidence rows early to reduce noise

// 2) Build a scalar set (array) of ports for fast membership tests in the main query
let SuspiciousPortList = toscalar(SuspiciousPortsData | summarize make_set(dest_port));

// 3) Keep a small projected table with port-level context for join/enrichment later
let PortDetails = SuspiciousPortsData | project dest_port, metadata_comment, metadata_confidence;

// 4) Main telemetry source: DeviceNetworkEvents
DeviceNetworkEvents
| where RemotePort in (SuspiciousPortList)          // only keep events that match the suspicious ports
| where RemotePort != 8080                           // example: ignore common benign port 8080 (tunable)
| where RemoteIP !in~ ("::1", "::ffff:127.0.0.1")    // filter out loopback-like addresses
| where not(
      RemoteIP startswith "10."                      // exclude RFC1918 private ranges (tunable)
      or RemoteIP startswith "192.168."
      or RemoteIP startswith "172."
      or RemoteIP startswith "8."                    // example public IP range exclusion (tunable)
      or RemoteIP startswith "127."
  )
// 5) join with CSV metadata to attach context (inner join keeps only known ports)
| join kind=inner (PortDetails) on $left.RemotePort == $right.dest_port

// 6) Aggregate to reduce noise and produce sampling values for triage
| summarize
    FirstSeen=min(Timestamp),
    LastSeen=max(Timestamp),
    Count=count(),
    SampleProcess=arg_max(Timestamp, InitiatingProcessFileName),
    SampleCommand=arg_max(Timestamp, InitiatingProcessCommandLine)
  by DeviceName, RemoteIP, RemotePort, metadata_comment, metadata_confidence

// 7) Map CSV confidence to internal risk levels
| extend RiskLevel = case(
    metadata_confidence == "high", "CRITICAL",
    metadata_confidence == "medium", "HIGH",
    "MEDIUM"  // default
  )

// 8) Keep only high/high-critical items to focus analyst attention (tunable)
| where RiskLevel in ("HIGH","CRITICAL")

// 9) MITRE mapping and analyst links
| extend
    MITRE_Tactics = "TA0011: Command and Control",
    MITRE_Techniques = case(
        RemotePort == 1080, "T1090: Proxy",
        RemotePort == 1194, "T1573: Encrypted Channel",
        "T1071: Application Layer Protocol"
    ),
    VT_Link = strcat("https://www.virustotal.com/gui/ip-address/", RemoteIP)

// 10) Build actionable hunting directives (pack_array produces an array)
| extend HuntingDirectives = pack_array(
    strcat("1. Verify legitimacy of process: ", SampleProcess),
    strcat("2. Inspect command line for anomalies: ", SampleCommand),
    strcat("3. Review ", tostring(Count), " suspicious connections to ", RemoteIP),
    strcat("4. Check VirusTotal reputation: ", VT_Link),
    strcat("5. Port usage context: ", metadata_comment),
    "6. Correlate with DeviceProcessEvents for parent-child process tree",
    "7. Check DeviceLogonEvents to identify the user session",
    "8. Isolate endpoint if risk is confirmed and collect memory dump"
  )

// 11) Final projection for UI / workbook
| project
    FirstSeen, LastSeen, DeviceName, RemoteIP, RemotePort, Count,
    RiskLevel, PortContext = metadata_comment, Confidence = metadata_confidence,
    SampleProcess, SampleCommand, MITRE_Tactics, MITRE_Techniques, VT_Link, HuntingDirectives

| order by RiskLevel desc, Count desc, FirstSeen desc
