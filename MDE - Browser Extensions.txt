// ===== Params =====
let lookback = 14d;
let feed_url = "https://raw.githubusercontent.com/mthcht/awesome-lists/refs/heads/main/Lists/Browser%20Extensions/browser_extensions_list.csv";
let exclude_types = dynamic(["sensitive","deceptive"]);  // feed categories you don't want to alert on
let ApprovedExtensionsWatchlist = "ApprovedBrowserExtensions"; // columns: ExtensionID, Reason
let ApprovedForceInstallWatchlist = "ApprovedForceInstall";    // columns: ExtensionID, Reason

// ===== Feed: pull, sanitize, and materialize =====
let MaliciousExtensions =
materialize(
  externaldata(
      browser_extension:string,
      browser_extension_id:string,
      metadata_category:string,
      metadata_type:string,
      metadata_link:string,
      metadata_comment:string
  )
  [feed_url]
  with (format="csv", ignoreFirstRecord=true)
  | extend NormalizedExtensionID = tolower(trim(" ", browser_extension_id))
  | where isnotempty(NormalizedExtensionID)
  // Chrome/Edge IDs are 32 lowercase letters (a-z); be strict to reduce FPs
  | where NormalizedExtensionID matches regex @"^[a-z]{32}$"
  | where tolower(metadata_type) !in (exclude_types)
  | project NormalizedExtensionID, browser_extension, metadata_category, metadata_type, metadata_link, metadata_comment
);

// ===== Allow-lists (optional) =====
let ApprovedExt =
  (_GetWatchlist(ApprovedExtensionsWatchlist)
   | project ApprovedID = tolower(tostring(ExtensionID)), ApprovedReason = tostring(Reason));
let ApprovedForce =
  (_GetWatchlist(ApprovedForceInstallWatchlist)
   | project ApprovedID = tolower(tostring(ExtensionID)), ApprovedReason = tostring(Reason));

// ===== Artifact 1: CRX files created (manual install / sideload) =====
let CrxDrops =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where ActionType == "FileCreated" and FileName endswith ".crx"
| extend // Extract 32 lowercase letters anywhere in filename
    NormalizedExtractedID = tolower(extract(@"([a-z]{32})", 1, FileName))
| where isnotempty(NormalizedExtractedID)
| project Timestamp, DeviceId, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine,
          FileName, FolderPath, SHA256, ArtifactType="CRXCreate", NormalizedExtractedID;

// ===== Artifact 2: Extension directory created (Chrome/Edge user profile) =====
// Chrome: C:\Users\<User>\AppData\Local\Google\Chrome\User Data\Default\Extensions\<id>\...
// Edge:   C:\Users\<User>\AppData\Local\Microsoft\Edge\User Data\Default\Extensions\<id>\...
let ExtFolderCreates =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where ActionType in~ ("FileCreated","FolderCreated")
| where FolderPath has @"\User Data\" and FolderPath has @"\Extensions\"
| extend NormalizedExtractedID = tolower(extract(@"\\Extensions\\([a-z]{32})\\", 1, tostring(FolderPath)))
| where isnotempty(NormalizedExtractedID)
| project Timestamp, DeviceId, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine,
          FileName, FolderPath, SHA256, ArtifactType="ExtFolder", NormalizedExtractedID;

// ===== Artifact 3: Manifest writes (manifest.json inside extension folder) =====
let ManifestWrites =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where ActionType in~ ("FileCreated","FileModified") and FileName =~ "manifest.json"
| where FolderPath has @"\User Data\" and FolderPath has @"\Extensions\"
| extend NormalizedExtractedID = tolower(extract(@"\\Extensions\\([a-z]{32})\\", 1, tostring(FolderPath)))
| where isnotempty(NormalizedExtractedID)
| project Timestamp, DeviceId, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine,
          FileName, FolderPath, SHA256, ArtifactType="Manifest", NormalizedExtractedID;

// ===== Artifact 4: Policy force-install (Chrome/Edge enterprise policy) =====
// HKLM\SOFTWARE\Policies\Google\Chrome\ExtensionInstallForcelist
// HKLM\SOFTWARE\Policies\Microsoft\Edge\ExtensionInstallForcelist
let PolicyForceInstall =
DeviceRegistryEvents
| where Timestamp >= ago(lookback)
| where ActionType in~ ("RegistryValueSet","RegistryValueAdded")
| where (RegistryKey startswith @"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Google\Chrome\ExtensionInstallForcelist"
     or  RegistryKey startswith @"HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Edge\ExtensionInstallForcelist")
| extend // values often look like "<extid>;https://clients2.google.com/service/update2/crx"
    NormalizedExtractedID = tolower(extract(@"([a-z]{32})", 1, tostring(RegistryValueData)))
| where isnotempty(NormalizedExtractedID)
| project Timestamp, DeviceId, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine,
          RegistryKey, RegistryValueName, RegistryValueData, ArtifactType="PolicyForce", NormalizedExtractedID;

// ===== Union all artifacts and join feed =====
union CrxDrops, ExtFolderCreates, ManifestWrites, PolicyForceInstall
| join kind=inner MaliciousExtensions on $left.NormalizedExtractedID == $right.NormalizedExtensionID
// Device context for prioritization
| join kind=leftouter (
    DeviceInfo
    | project DeviceId, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags
) on DeviceId
// Allow-list suppression
| join kind=leftouter (ApprovedExt)  on $left.NormalizedExtractedID == $right.ApprovedID
| join kind=leftouter (ApprovedForce) on $left.NormalizedExtractedID == $right.ApprovedID
| where isnull(ApprovedExt.ApprovedID) and not(ArtifactType=="PolicyForce" and isnotnull(ApprovedForce.ApprovedID))
// Enrichments & scoring
| extend
    ChromeWebStore   = strcat("https://chrome.google.com/webstore/detail/", browser_extension, "/", NormalizedExtractedID),
    EdgeAddonsStore  = strcat("https://microsoftedge.microsoft.com/addons/detail/", browser_extension, "/", NormalizedExtractedID),
    CRXcavator       = strcat("https://crxcavator.io/report/", NormalizedExtractedID),
    VT_Link          = iif(isnotempty(SHA256), strcat("https://www.virustotal.com/gui/file/", SHA256), ""),
    // Risk scoring: artifact + category + exposure + loader
    BaseScore = case(
        tolower(metadata_category) has_any ("malware","stealer","adware","cryptominer","c2","hijacker"), 2,
        tolower(metadata_category) has_any ("tracking","grayware"), 1,
        0
    ),
    ArtifactScore = case(
        ArtifactType == "PolicyForce", 2,          // org-wide persistence risk
        ArtifactType == "CRXCreate",  1,           // on-disk installer drop
        ArtifactType == "ExtFolder",  1,
        ArtifactType == "Manifest",   1,
        0
    ),
    ExpoScore = case(ExposureLevel =~ "High", 2, ExposureLevel =~ "Medium", 1, 0),
    LoaderScore = case( // LOLBins and scripting engines bump risk
        InitiatingProcessFileName in~ ("powershell.exe","wscript.exe","cscript.exe","mshta.exe","rundll32.exe","cmd.exe","curl.exe"), 1,
        0
    ),
    SevNum = 1 + BaseScore + ArtifactScore + ExpoScore + LoaderScore
| extend Severity = case(SevNum >= 5, "CRITICAL", SevNum >= 4, "HIGH", SevNum >= 2, "MEDIUM", "LOW")
// ATT&CK mapping (installation + persistence + exfil/collection)
| extend
    MITRE_Tactics = "TA0003: Persistence, TA0005: Defense Evasion, TA0009: Collection, TA0010: Exfiltration",
    MITRE_Techniques = case(
        ArtifactType == "PolicyForce", "T1053/T1112 (Policy/Registry abuse), T1546 (Event-triggered execution)",
        "T1176: Browser Extensions, T1112: Modify Registry"
    )
// Group repeats per device+extension id
| summarize
    FirstSeen = min(Timestamp),
    LastSeen  = max(Timestamp),
    EventCount = count(),
    SampleLoader = arg_max(Timestamp, InitiatingProcessFileName),
    SampleCmd    = arg_max(Timestamp, InitiatingProcessCommandLine),
    AnySHA256    = any(SHA256),
    AnyFolder    = any(FolderPath),
    AnyFileName  = any(FileName),
    AnyRegKey    = any(RegistryKey),
    AnyRegValue  = any(RegistryValueData)
    by DeviceId, DeviceName, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags,
       NormalizedExtractedID, browser_extension, metadata_category, metadata_type, metadata_link, metadata_comment,
       ArtifactType, Severity, MITRE_Tactics, MITRE_Techniques, ChromeWebStore, EdgeAddonsStore, CRXcavator, VT_Link
// Hunter directives tailored to the result
| extend HuntingDirectives = pack_array(
    strcat("1) Validate if extension '", browser_extension, "' (", NormalizedExtractedID, ") is sanctioned on ", DeviceName, "."),
    strcat("2) Review loader lineage: ", tostring(SampleLoader), " | ", tostring(SampleCmd)),
    strcat("3) Check install artifact: ", iif(ArtifactType=="PolicyForce",
            strcat("Policy force-install (", tostring(AnyRegKey), " -> ", tostring(AnyRegValue), ")"),
            strcat("File ", tostring(AnyFileName), " @ ", tostring(AnyFolder)))),
    "4) Scope across estate: pivot by extension ID across DeviceFileEvents and DeviceRegistryEvents.",
    strcat("5) Enrich: Chrome Web Store=", ChromeWebStore, " | Edge=", EdgeAddonsStore, " | CRXcavator=", CRXcavator,
           iif(isnotempty(VT_Link), strcat(" | VT(file)=", VT_Link), "")),
    strcat("6) Review permissions in CRXcavator and store listing; compare to feed category/type: ", metadata_category, "/", metadata_type),
    "7) If unsanctioned: remove the extension, clear user profiles, and block via policy (ExtensionInstallBlocklist / allow-only list).",
    "8) If PolicyForce and not approved: remediate GPO/MDM setting; audit who changed it.",
    "9) Hunt for data access/exfil in browser artifacts (history, cookies, local storage) and proxy logs.",
    "10) Add extension ID to egress proxy/EDR block/alerts and document exception if needed."
)
// Final projection
| project FirstSeen, LastSeen, EventCount, Severity,
          DeviceName, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags,
          ArtifactType, browser_extension, ExtensionID=NormalizedExtractedID,
          metadata_category, metadata_type, metadata_comment, metadata_link,
          SampleLoader, SampleCmd,
          ChromeWebStore, EdgeAddonsStore, CRXcavator, VT_Link,
          HuntingDirectives
| order by case(Severity=="CRITICAL",4, Severity=="HIGH",3, Severity=="MEDIUM",2, 1) desc, LastSeen desc
