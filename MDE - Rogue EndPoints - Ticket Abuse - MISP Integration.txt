// Detect devices with non-standard names or missing EDR onboarding
let rogueHost = "ROGUE";       // set known suspicious host, or "" to scan all
let lookback = 30d;

// Approved naming pattern (adjust to your org)
let approvedRegex = @"^ACME-(DC|SVC|SQL|WIN|LAP|ADMIN)-\d{2}$";

// DeviceInfo (Defender Advanced Hunting) — fields may vary; adjust to your tenant schema
DeviceInfo
| where TimeGenerated >= ago(lookback)
| extend Computer = DeviceName, DeviceId = tostring(DeviceId), OnboardState = tostring(OnboardingState)
| where isempty(rogueHost) or Computer == rogueHost
| extend NameOk = Computer matches regex approvedRegex
| extend IsOnboarded = iff(isnotempty(DeviceId) and OnboardState == "Onboarded", 1, 0)
| where NameOk == false or IsOnboarded == 0
| project TimeGenerated, Computer, DeviceId, OnboardState, OSPlatform, LastSeen = TimeGenerated
| order by TimeGenerated desc


let host = "ROGUE";
DeviceNetworkEvents
| where Timestamp >= ago(24h)
| where DeviceName == host
| where RemotePort in (389,636) // LDAP / LDAPS
| project Timestamp, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, RemoteIP, RemotePort, BytesSent, BytesReceived
| order by Timestamp desc


let host = "ROGUE";
DeviceProcessEvents
| where Timestamp >= ago(24h) and DeviceName == host
| where FileName in ("powershell.exe","pwsh.exe","python.exe","rubeus.exe") 
    or ProcessCommandLine has_any ("GetUserSPNs","Invoke-GetUserSPNs","Get-ADUser","System.DirectoryServices","Invoke-Kerberoast","secretsdump")
| project Timestamp, DeviceName, FileName, ProcessCommandLine, InitiatingProcessAccountName
| order by Timestamp desc


// DC pivot: SPN reads & TGS requests (authoritative)
let lookback = 48h;
let targetHost = "ROGUE-EXT-17";  // or "" to search domain-wide

// SPN reads (4662/5136) - requires AD attribute auditing on DCs
SecurityEvent
| where TimeGenerated >= ago(lookback)
| where EventID in (4662,5136)
| where tostring(ObjectProperties) contains "servicePrincipalName" or tostring(TargetObject) contains "servicePrincipalName"
| extend Actor = tostring(SubjectUserName), DCHost = tostring(Computer), Details = tostring(ObjectProperties)
| where isnull(targetHost) or Actor == targetHost or DCHost has targetHost
| project TimeGenerated, DCHost, Actor, Details
| order by TimeGenerated desc

// TGS requests (4769)
SecurityEvent
| where TimeGenerated >= ago(lookback) and EventID == 4769
| extend SPN = tostring(ServiceName), EncType = tostring(TicketEncryptionType), Requestor = tostring(AccountName), SourceHost = tostring(Computer)
| where SourceHost == targetHost or Requestor == targetHost
| summarize TGSRequests = count(), RC4Count = countif(tolower(EncType) == "0x17") by Requestor, SPN, SourceHost
| order by TGSRequests desc




// ===============================================
// 1️⃣ Detect devices with non-standard names or missing EDR onboarding
// Purpose: Identify rogue devices that are either not onboarded to EDR or do not follow approved naming conventions.
// ===============================================

let rogueHost = "ROGUE";       // optional: set a specific suspicious host
let lookback = 30d;

// Approved device naming pattern for your organization
let approvedRegex = @"^ACME-(DC|SVC|SQL|WIN|LAP|ADMIN)-\d{2}$";

DeviceInfo
| where TimeGenerated >= ago(lookback)
| extend Computer = DeviceName, DeviceId = tostring(DeviceId), OnboardState = tostring(OnboardingState)
| where isempty(rogueHost) or Computer == rogueHost
| extend NameOk = Computer matches regex approvedRegex
| extend IsOnboarded = iff(isnotempty(DeviceId) and OnboardState == "Onboarded", 1, 0)
| where NameOk == false or IsOnboarded == 0
| project TimeGenerated, Computer, DeviceId, OnboardState, OSPlatform, LastSeen = TimeGenerated
| order by TimeGenerated desc

// Note: MISP enrichment here is limited, but if a device name is known from previous attacks or threat intel feeds, 
// you could join with a MISP table containing known compromised hosts to boost scoring.

// ===============================================
// 2️⃣ Detect suspicious LDAP/LDAPS connections from a host
// Purpose: Track possible reconnaissance or exfil attempts over LDAP/LDAPS from suspicious hosts
// ===============================================

let host = "ROGUE";

DeviceNetworkEvents
| where Timestamp >= ago(24h)
| where DeviceName == host
| where RemotePort in (389,636) // LDAP / LDAPS
| project Timestamp, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, RemoteIP, RemotePort, BytesSent, BytesReceived
| join kind=leftouter (
    // MISP enrichment: check if the remote IP is a known C2 or malicious host
    ThreatIntelligenceIndicator
    | where IndicatorType == "IP"
    | project TI_Indicator = Indicator, TI_Score = 100
) on $left.RemoteIP == $right.TI_Indicator
| extend TotalScore = coalesce(TI_Score,0)
| order by TotalScore desc, Timestamp desc

// ===============================================
// 3️⃣ Detect suspicious processes and commands related to AD/kerberos attacks
// Purpose: Identify attacks like Kerberoasting, SPN harvesting, or NTDS dumps
// ===============================================

let host = "ROGUE";

DeviceProcessEvents
| where Timestamp >= ago(24h) and DeviceName == host
| where FileName in ("powershell.exe","pwsh.exe","python.exe","rubeus.exe") 
    or ProcessCommandLine has_any ("GetUserSPNs","Invoke-GetUserSPNs","Get-ADUser","System.DirectoryServices","Invoke-Kerberoast","secretsdump")
| project Timestamp, DeviceName, FileName, ProcessCommandLine, InitiatingProcessAccountName
| join kind=leftouter (
    // MISP enrichment: known tools or malicious scripts
    ThreatIntelligenceIndicator
    | where IndicatorType in ("FileName","FileHash")
    | project TI_Indicator = Indicator, TI_Score = 100
) on $left.FileName == $right.TI_Indicator
| extend TotalScore = coalesce(TI_Score,0)
| order by TotalScore desc, Timestamp desc

// ===============================================
// 4️⃣ Domain Controller pivot: SPN reads & TGS requests
// Purpose: Detect reconnaissance and Kerberos ticket abuse on DCs (Golden Ticket or Kerberoast)
// ===============================================

// SPN reads (Event IDs 4662/5136)
let lookback = 48h;
let targetHost = "ROGUE-EXT-17";  // optional: focus on a specific host

SecurityEvent
| where TimeGenerated >= ago(lookback)
| where EventID in (4662,5136)
| where tostring(ObjectProperties) contains "servicePrincipalName" or tostring(TargetObject) contains "servicePrincipalName"
| extend Actor = tostring(SubjectUserName), DCHost = tostring(Computer), Details = tostring(ObjectProperties)
| where isnull(targetHost) or Actor == targetHost or DCHost has targetHost
| project TimeGenerated, DCHost, Actor, Details
| join kind=leftouter (
    // MISP enrichment: flag if Actor or DCHost is a known malicious entity
    ThreatIntelligenceIndicator
    | where IndicatorType == "FileName" or IndicatorType == "IP"
    | project TI_Indicator = Indicator, TI_Score = 100
) on $left.Actor == $right.TI_Indicator or $left.DCHost == $right.TI_Indicator
| extend TotalScore = coalesce(TI_Score,0)
| order by TotalScore desc, TimeGenerated desc

// TGS requests (Event ID 4769)
SecurityEvent
| where TimeGenerated >= ago(lookback) and EventID == 4769
| extend SPN = tostring(ServiceName), EncType = tostring(TicketEncryptionType), Requestor = tostring(AccountName), SourceHost = tostring(Computer)
| where SourceHost == targetHost or Requestor == targetHost
| summarize TGSRequests = count(), RC4Count = countif(tolower(EncType) == "0x17") by Requestor, SPN, SourceHost
| join kind=leftouter (
    // MISP enrichment: flag Requestor accounts or SPNs known from threat intel
    ThreatIntelligenceIndicator
    | where IndicatorType in ("FileName","UserName")
    | project TI_Indicator = Indicator, TI_Score = 100
) on $left.Requestor == $right.TI_Indicator or $left.SPN == $right.TI_Indicator
| extend TotalScore = coalesce(TI_Score,0)
| order by TGSRequests desc, TotalScore desc







